# v1.0 仕様書

## 1. 概要

本ドキュメントは、LINE風チャット恋愛シミュレーションゲーム「LINEで彼女を落とせ！」のv1.0における機能、デザイン、および技術的な側面を定義するものです。

## 2. 機能一覧

### 2.1. コア機能

*   **LINE風チャットUI**: メッセージの吹き出し（ユーザー側は右、AI側は左）、背景色、入力欄、送信ボタンなど、LINEの基本的なチャット画面を模倣。
*   **AIキャラクターとの会話**: Google Gemini APIを利用し、ユーザーの入力メッセージに対してAIキャラクターが応答を生成。
*   **好感度システム**: AIの返答内容に含まれる特定のキーワード（例: 「ありがとう」「ごめん」など）に基づいて、AIキャラクターの好感度（0〜9の範囲）が変動。
*   **会話回数制限**: 会話が10回に達するとゲームが終了。
*   **ゲームクリア/オーバー判定**: 会話終了時の好感度に応じて、ゲームのクリア（好感度7以上）またはオーバー（好感度2以下）を判定し、結果をアラートで表示。
*   **メッセージのタイムスタンプ表示**: 各メッセージの送信時刻を「HH:MM」形式で表示。
*   **ユーザーメッセージの既読マーク表示**: ユーザーが送信したメッセージに対して、AIからの返信があった場合に「既読」マークを表示。

### 2.2. その他の機能

*   **初期メッセージ**: ゲーム開始時にAIキャラクターからの初期メッセージを表示。
*   **入力フィールドの自動フォーカス**: メッセージ送信後、入力フィールドに自動的にフォーカスが戻る。
*   **エラーハンドリング**: AIからの応答取得に失敗した場合、ユーザーにエラーメッセージを表示。

## 3. デザイン

*   **全体**: LINEアプリのチャット画面を参考に、シンプルで直感的なUIを目指す。
*   **配色**: 緑を基調としたLINEのブランドカラーを意識した配色。
*   **吹き出し**: ユーザーメッセージは緑色の角丸、AIメッセージは白色の角丸。
*   **フォント**: 可読性の高いシステムフォントを使用。

## 4. 技術スタック

*   **フロントエンド**: HTML, CSS, JavaScript
*   **バックエンド**: Node.js (Express.js)
*   **AI**: Google Gemini API
*   **開発ツール**: live-server, Puppeteer (自動テスト用)

## 5. 既知の問題点と今後の課題

### 5.1. 既知の問題点

*   **会話履歴のLLMへの引き継ぎ**: 現在、LLMへのリクエストはユーザーの最新メッセージのみ。過去の会話履歴が考慮されないため、文脈を理解した自然な会話が難しい場合がある。
*   **好感度変化ロジックの単純さ**: LLMからの返答内容に含まれる特定のキーワードのみで好感度を変化させているため、より複雑な感情や文脈を理解した好感度変化ができていない。
*   **メッセージの長さのバリエーション不足**: LLMからの返信が、常に同じような長さになりがちで、会話の自然さに欠ける場合がある。
*   **タイムスタンプと既読マークの位置調整**: ユーザーメッセージのタイムスタンプと既読マークが、吹き出しの下に、かつ右寄せで表示されるべきだが、現状では左端に表示される。

### 5.2. 今後の課題（優先度順）

1.  **会話履歴のLLMへの引き継ぎ**: LLMが過去の会話を記憶し、より連続性のある返答を生成できるようにする。
    *   `script.js`で会話履歴を管理し、バックエンドに送信する。
    *   `server/index.js`で会話履歴を受け取り、LLMに渡す。
2.  **好感度変化ロジックの洗練**: より複雑な感情や文脈を理解して好感度を変化させる。LLMの返答から好感度への影響度を判断できるようにする。
    *   LLMに好感度変化のトリガーとなるキーワードや感情を明示的に出力させるプロンプト調整。
    *   返答の感情分析を行う（より高度な課題）。
3.  **メッセージの長さの変化**: LLMからの返信が、時には短く、時には長く、複数の文で返答するように調整する。
    *   バックエンドのLLMプロンプトに、返答の長さにバリエーションを持たせる指示を追加。
    *   `maxOutputTokens`の調整。
4.  **タイムスタンプと既読マークの位置調整**: LINEのUIに近づけるため、タイムスタンプと既読マークをユーザーメッセージの吹き出しの右下に配置する。
    *   `style.css`のFlexboxプロパティを再調整し、要素の配置を修正する。
5.  **ゲームクリア/オーバー条件の調整**: 特定の会話内容やユーザーの行動がゲーム結果に影響するようにする。
    *   特定のキーワードや会話の進捗に応じて、好感度への影響を大きくする。
6.  **キャラクター設定の強化**: より詳細な設定（年齢、職業、趣味、口癖など）を追加し、より魅力的で一貫性のあるAIキャラクターにする。
    *   `docs/character_settings.md`に詳細な設定を記述し、LLMプロンプトに反映させる。
